<?php
// generateUsersPHP method for PanelInstaller
function generateUsersPHP($userTier) {
    return '<?php
session_start();
require_once "config.php";

if (!isset($_SESSION["admin_logged_in"])) {
    header("Location: login.php");
    exit;
}

// Handle user actions
if ($_POST) {
    $action = $_POST["action"] ?? "";
    
    if ($action === "toggle_status") {
        $userId = $_POST["user_id"];
        $newStatus = $_POST["status"] === "active" ? "inactive" : "active";
        
        $stmt = $pdo->prepare("UPDATE ssh_users SET status = ? WHERE id = ?");
        $result = $stmt->execute([$newStatus, $userId]);
        
        if ($result) {
            // Update system user
            $userInfo = $pdo->prepare("SELECT username FROM ssh_users WHERE id = ?");
            $userInfo->execute([$userId]);
            $user = $userInfo->fetch();
            
            if ($newStatus === "active") {
                shell_exec("usermod -s /bin/bash " . escapeshellarg($user["username"]));
            } else {
                shell_exec("usermod -s /bin/false " . escapeshellarg($user["username"]));
            }
            
            $message = "User status updated successfully";
        } else {
            $error = "Failed to update user status";
        }
    }
}

// Get all users
$stmt = $pdo->query("SELECT * FROM ssh_users ORDER BY created_at DESC");
$users = $stmt->fetchAll();

// Get statistics
$statsQuery = "SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN status = \"active\" THEN 1 ELSE 0 END) as active,
    SUM(CASE WHEN status = \"inactive\" THEN 1 ELSE 0 END) as inactive,
    SUM(CASE WHEN expire_date < CURDATE() THEN 1 ELSE 0 END) as expired
FROM ssh_users";
$stats = $pdo->query($statsQuery)->fetch();
?>
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - SSH Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <h2><i class="fas fa-server"></i> SSH Panel</h2>
            <span class="tier-badge tier-' . strtolower($userTier) . '">' . ucfirst($userTier) . '</span>
        </div>
        <nav class="nav-menu">
            <a href="index.php" class="nav-item">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="users.php" class="nav-item active">
                <i class="fas fa-users"></i> Users Management
            </a>
            <a href="add_user.php" class="nav-item">
                <i class="fas fa-user-plus"></i> Add User
            </a>
            ' . ($userTier === 'premium' || $userTier === 'enterprise' ? '
            <a href="reports.php" class="nav-item">
                <i class="fas fa-chart-bar"></i> Reports
            </a>
            <a href="settings.php" class="nav-item">
                <i class="fas fa-cog"></i> Settings
            </a>' : '') . '
            ' . ($userTier === 'enterprise' ? '
            <a href="multi_server.php" class="nav-item">
                <i class="fas fa-network-wired"></i> Multi Server
            </a>
            <a href="api_keys.php" class="nav-item">
                <i class="fas fa-key"></i> API Keys
            </a>' : '') . '
            <a href="logout.php" class="nav-item logout">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Users Management</h1>
            <div class="header-actions">
                <a href="add_user.php" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add New User
                </a>
            </div>
        </div>

        <?php if (isset($message)): ?>
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> <?php echo $message; ?>
        </div>
        <?php endif; ?>

        <?php if (isset($error)): ?>
        <div class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i> <?php echo $error; ?>
        </div>
        <?php endif; ?>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3><?php echo $stats["total"]; ?></h3>
                    <p>Total Users</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-info">
                    <h3><?php echo $stats["active"]; ?></h3>
                    <p>Active Users</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-times"></i>
                </div>
                <div class="stat-info">
                    <h3><?php echo $stats["inactive"]; ?></h3>
                    <p>Inactive Users</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-clock"></i>
                </div>
                <div class="stat-info">
                    <h3><?php echo $stats["expired"]; ?></h3>
                    <p>Expired Users</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>All Users</h3>
                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Max Connections</th>
                                <th>Expire Date</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($users as $user): ?>
                            <tr>
                                <td>
                                    <div class="user-info">
                                        <i class="fas fa-user"></i>
                                        <span><?php echo htmlspecialchars($user["username"]); ?></span>
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge status-<?php echo $user["status"]; ?>">
                                        <?php echo ucfirst($user["status"]); ?>
                                    </span>
                                </td>
                                <td><?php echo $user["max_connections"]; ?></td>
                                <td>
                                    <?php if ($user["expire_date"]): ?>
                                        <?php 
                                        $expireDate = new DateTime($user["expire_date"]);
                                        $now = new DateTime();
                                        $isExpired = $expireDate < $now;
                                        ?>
                                        <span class="<?php echo $isExpired ? \"text-danger\" : \"\"; ?>">
                                            <?php echo $expireDate->format("Y-m-d"); ?>
                                        </span>
                                    <?php else: ?>
                                        <span class="text-muted">Never</span>
                                    <?php endif; ?>
                                </td>
                                <td><?php echo date("Y-m-d H:i", strtotime($user["created_at"])); ?></td>
                                <td>
                                    <div class="action-buttons">
                                        <form method="POST" style="display: inline;">
                                            <input type="hidden" name="action" value="toggle_status">
                                            <input type="hidden" name="user_id" value="<?php echo $user["id"]; ?>">
                                            <input type="hidden" name="status" value="<?php echo $user["status"]; ?>">
                                            <button type="submit" class="btn btn-sm <?php echo $user["status"] === \"active\" ? \"btn-warning\" : \"btn-success\"; ?>" 
                                                    onclick="return confirm(\"Are you sure?\")">
                                                <i class="fas fa-<?php echo $user["status"] === \"active\" ? \"pause\" : \"play\"; ?>"></i>
                                            </button>
                                        </form>
                                        <button class="btn btn-sm btn-primary" onclick="editUser(<?php echo $user["id"]; ?>)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteUser(<?php echo $user["id"]; ?>)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        function filterUsers() {
            const input = document.getElementById("userSearch");
            const filter = input.value.toLowerCase();
            const table = document.getElementById("usersTable");
            const rows = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                const username = rows[i].getElementsByTagName("td")[0].textContent.toLowerCase();
                if (username.indexOf(filter) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }

        function editUser(userId) {
            window.location.href = "edit_user.php?id=" + userId;
        }

        function deleteUser(userId) {
            if (confirm("Are you sure you want to delete this user? This action cannot be undone.")) {
                fetch("api.php", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        action: "delete_user",
                        user_id: userId
                    })
                })
                .then(response => response.json())
                .then(data => {